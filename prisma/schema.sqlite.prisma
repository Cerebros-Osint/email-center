// Schema SQLite pour tests rapides
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum OrgRole {
  Owner
  Admin
  Member
}

enum MessageStatus {
  draft
  queued
  sent
  failed
  paused
}

enum RecipientStatus {
  pending
  sent
  failed
  suppressed
}

enum AttemptResult {
  ok
  fail
}

enum DmarcPolicy {
  none
  quarantine
  reject
}

enum AlignMode {
  r
  s
}

enum DnsProvider {
  route53
  cloudflare
}

model Org {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          OrgUser[]
  settings       OrgSettings?
  smtpAccounts   SmtpAccount[]
  identities     Identity[]
  messages       Message[]
  domainConfigs  DomainConfig[]
  suppressions   SuppressedRecipient[]
  unsubscribes   Unsubscribe[]
  inboundMessages InboundMessage[]
  auditLogs      AuditLog[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orgs      OrgUser[]
  auditLogs AuditLog[]
}

model OrgUser {
  orgId  String
  userId String
  role   OrgRole
  joinedAt DateTime @default(now())

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@index([userId])
}

model OrgSettings {
  id                     String   @id @default(uuid())
  orgId                  String   @unique
  killSwitch             Boolean  @default(false)
  rateLimitPerMin        Int?
  rateLimitPerDay        Int?
  retentionDaysRawSource Int?
  listUnsubscribeEnabled Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model SmtpAccount {
  id             String   @id @default(uuid())
  orgId          String
  provider       String
  host           String
  port           Int
  username       String
  passwordEnc    Bytes
  fromEmail      String
  rateLimitPerMin Int?
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org          Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  capabilities ProviderCapabilities?
  identities   Identity[]
  recipients   Recipient[]
  sendAttempts SendAttempt[]

  @@index([orgId])
  @@index([status])
}

model ProviderCapabilities {
  id             String   @id @default(uuid())
  smtpAccountId  String   @unique
  starttls       Boolean  @default(true)
  size           Int?
  pipelining     Boolean  @default(false)
  eightBitMime   Boolean  @default(false)
  latencyMs      Int?
  lastTestAt     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  smtpAccount SmtpAccount @relation(fields: [smtpAccountId], references: [id], onDelete: Cascade)
}

model Identity {
  id                   String   @id @default(uuid())
  orgId                String
  displayName          String
  fromEmail            String
  defaultSmtpAccountId String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  org                Org         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  defaultSmtpAccount SmtpAccount @relation(fields: [defaultSmtpAccountId], references: [id])
  messages           Message[]

  @@index([orgId])
}

model Message {
  id           String        @id @default(uuid())
  orgId        String
  identityId   String
  subject      String
  bodyHtml     String?
  bodyText     String?
  sendStatus   MessageStatus @default(draft)
  replyToToken String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  org        Org         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  identity   Identity    @relation(fields: [identityId], references: [id])
  recipients Recipient[]

  @@index([orgId])
  @@index([sendStatus])
}

model Recipient {
  id                 String          @id @default(uuid())
  messageId          String
  toEmail            String
  sendStatus         RecipientStatus @default(pending)
  mxDomain           String?
  mxRecordsJson      String?
  lastMxCheckedAt    DateTime?
  routeSmtpAccountId String?
  sentAt             DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  message      Message       @relation(fields: [messageId], references: [id], onDelete: Cascade)
  smtpAccount  SmtpAccount?  @relation(fields: [routeSmtpAccountId], references: [id])
  sendAttempts SendAttempt[]

  @@index([messageId])
  @@index([sendStatus])
  @@index([mxDomain])
}

model SendAttempt {
  id             String        @id @default(uuid())
  recipientId    String
  smtpAccountId  String
  providerMsgId  String?
  result         AttemptResult
  responseRaw    String?
  latencyMs      Int
  createdAt      DateTime      @default(now())

  recipient   Recipient   @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  smtpAccount SmtpAccount @relation(fields: [smtpAccountId], references: [id])

  @@index([recipientId])
  @@index([result])
  @@index([createdAt])
}

model DomainConfig {
  id                   String       @id @default(uuid())
  orgId                String
  domain               String
  dkimSelectorCurrent  String?
  dkimSelectorNext     String?
  dkimRotateAt         DateTime?
  dmarcPolicy          DmarcPolicy  @default(none)
  dmarcPct             Int          @default(100)
  aspf                 AlignMode    @default(r)
  adkim                AlignMode    @default(r)
  ruaMailto            String?
  lastDmarcAdjustedAt  DateTime?
  lastDnsCheckAt       DateTime?
  dnsProvider          DnsProvider?
  dnsProviderZoneId    String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, domain])
  @@index([domain])
}

model SuppressedRecipient {
  id        String   @id @default(uuid())
  orgId     String
  email     String
  reason    String
  createdAt DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, email])
  @@index([email])
}

model Unsubscribe {
  id        String   @id @default(uuid())
  orgId     String
  email     String
  token     String   @unique
  method    String
  createdAt DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, email])
  @@index([email])
}

model InboundMessage {
  id           String   @id @default(uuid())
  orgId        String
  replyToToken String?
  fromEmail    String
  toEmail      String
  subject      String
  bodyText     String?
  bodyHtml     String?
  rawSource    String?
  threadId     String?
  receivedAt   DateTime
  createdAt    DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([replyToToken])
  @@index([threadId])
}

model AuditLog {
  id        String   @id @default(uuid())
  orgId     String
  userId    String?
  action    String
  resource  String
  details   String?
  createdAt DateTime @default(now())

  org  Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([orgId])
  @@index([action])
  @@index([createdAt])
}
